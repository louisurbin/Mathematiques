<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Série de Fourier</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"">
        <style>
            body {
                font-family: Brush Script MT;
                font-size: 32px;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                height: 100vh;
                margin: 0;
            }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    </head>
    <body>
        <h1>Série de Fourier</h1>
        <script>
            let y = [];
            let fourierX;
            
            let time = 0;
            let wave = [];

            class Complex {
                constructor(a, b) {
                    this.re = a;
                    this.im = b;
                }

                add(c) {
                    this.re += c.re;
                    this.im += c.im;
                }

                mult(c) {
                    const re = this.re * c.re - this.im * c.im;
                    const im = this.re * c.im + this.im * c.re;
                    return new Complex(re, im);
                }
            }

            function setup() {
                createCanvas(800, 600);
                                
                fourierY = dft(y);
            }

            function dft(x) {
                const X =[];
                const N = x.length;
                for (let k = 0; k < N; k++) {
                    let sum = new Complex(0, 0);
                    for (let n = 0;n < N; n++) {
                        const phi = (TWO_PI * k * n) / N;
                        const c = new Complex(cos(phi), -sin(phi));  // e^(-i*phi)
                        sum.add(x[n].mult(c));
                    }
                    sum.re /= N;
                    sum.im /= N;

                    let freq = k;
                    let amp = sqrt(sum.re * sum.re + sum.im * sum.im);
                    let phase = atan2(sum.im, sum.re);
                    X[k] = {re: sum.re, im: sum.im, freq, amp, phase};
                }                
                return X;
            }

            function epicycles(x, y, rotation, fourier) {
                for (let i = 0; i < fourier.length; i++) {
                    let prevx = x;
                    let prevy = y;
                    let freq = fourier[i].freq;
                    let radius = fourier[i].amp;
                    let phase = fourier[i].phase;
                    x += radius * cos(freq * time + phase + rotation);
                    y += radius * sin(freq * time + phase + rotation);

                    stroke(255, 100);
                    noFill();
                    ellipse(prevx, prevy, radius * 2);
                    stroke(255);
                    line(prevx, prevy, x, y);
                }
                return createVector(x, y);
            }

            function draw() {
                background(0);
                epicycles(400, 300, fourierX);
                wave.unshift(y);
                translate(200, 0);
                line(x - 200, y, 0, wave[0]);

                beginShape();
                noFill();
                for (let i = 0; i < wave.length; i++) {
                    vertex(i, wave[i]);
                }
                endShape();

                const dt = TWO_PI / fourierY.length;
                time +=0.05; // Le signe change le sens de parcours

                if (wave.length > 500) {
                    wave.pop();
                }
            }
        </script>
    </body>
</html>
