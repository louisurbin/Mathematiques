<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portrait de Phase</title>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.0.0/math.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
        }
        #plot {
            width: 100%;
            height: 600px;
        }
        .input-group {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Portrait de Phase d'un Système Dynamique à Deux Inconnues</h1>
    <div class="input-group">
        <label for="equation1">Équation 1 (dx/dt): </label>
        <input type="text" id="equation1" placeholder="Ex: x*(1-x-y)">
    </div>
    <div class="input-group">
        <label for="equation2">Équation 2 (dy/dt): </label>
        <input type="text" id="equation2" placeholder="Ex: y*(x-y)">
    </div>
    <div class="input-group">
        <button onclick="plotPhasePortrait()">Tracer le Portrait de Phase</button>
    </div>
    <div id="plot"></div>
    <script>
        function plotPhasePortrait() {
            // Récupérer les équations fournies par l'utilisateur
            const eq1 = document.getElementById('equation1').value;
            const eq2 = document.getElementById('equation2').value;

            // Compiler les équations avec math.js
            const equation1 = math.compile(eq1);
            const equation2 = math.compile(eq2);

            // Définir le système d'équations différentielles
            function system(t, z) {
                const x = z[0], y = z[1];
                return [equation1.evaluate({x: x, y: y}), equation2.evaluate({x: x, y: y})];
            }

            // Résoudre les équations différentielles pour différentes conditions initiales
            function solveSystem(initialConditions, tMax, dt) {
                const t = numeric.linspace(0, tMax, tMax / dt);
                const sol = numeric.dopri(0, tMax, initialConditions, system, 1e-6, 2000);
                return sol.at(t);
            }

            const tMax = 25;
            const dt = 0.01;
            const initialConditionsList = [
                [0.1, 0.1],
                [-0.5, 0.5],
                [0.9, -0.9],
                [-0.1, -0.9],
            ];
            const traces = [];

            initialConditionsList.forEach(initCond => {
                const sol = solveSystem(initCond, tMax, dt);
                traces.push({
                    x: sol[0],
                    y: sol[1],
                    mode: 'lines',
                    name: `Init: (${initCond[0]}, ${initCond[1]})`
                });
            });

            // Ajouter les flèches de champ de direction
            const x = numeric.linspace(0, 20, 200);
            const y = numeric.linspace(0, 20, 200);
            const u = [];
            const v = [];
            x.forEach(xi => {
                y.forEach(yi => {
                    const [dx, dy] = system(0, [xi, yi]);
                    u.push(dx);
                    v.push(dy);
                });
            });

            traces.push({
                x: numeric.rep([20, 20], x),
                y: numeric.rep([20, 20], y),
                u: u,
                v: v,
                type: 'scatter',
                mode: 'markers',
                marker: { color: 'black', size: 2 },
                name: 'Direction Field'
            });

            const layout = {
                title: 'Portrait de Phase du Système Dynamique',
                xaxis: { title: 'x', range: [0, 20]},
                yaxis: { title: 'y', range: [0, 20]}
            };

            Plotly.newPlot('plot', traces, layout);
        }
    </script>
</body>
</html>